# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# Orbs are reusable packages of CircleCI configuration that you may share across projects, enabling you to create encapsulated, parameterized commands, jobs, and executors that can be used across multiple projects.
# See: https://circleci.com/docs/2.0/orb-intro/
orbs:
  ruby: circleci/ruby@1.4.0

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  build:
    docker:
      - image: cimg/ruby:3.0
    executor: ruby/default
    steps:
      - checkout
      - run:
          name: Which bundler?
          command: bundle -v
      - ruby/install-deps

  test:
    docker:
      - image: cimg/ruby:3.0
        environment:
          - STAGE: test
          - MONGO_HOST: localhost
          - REDIS_HOST: localhost
      - image: mongo:4.2
      - image: redis:6.2

    steps:
      - checkout
      - ruby/install-deps
      - run:
          command: "dockerize -wait tcp://localhost:27017 -timeout 1m"
          name: Wait for DB
      - run:
          command: "dockerize -wait tcp://localhost:6379 -timeout 1m"
          name: Wait for Redis
      - run:
          command: shopt -s globstar
      - ruby/rspec-test:
          include: spec/**/*_spec.rb

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  sample: # This is the name of the workflow, feel free to change it to better match your workflow.
    # Inside the workflow, you define the jobs you want to run.
    jobs:
      - build
      - test:
          requires:
            - build

    # name: Ruby ${{ matrix.ruby }}, MongoDB ${{ matrix.mongodb }}, Redis ${{ matrix.redis }}
    # services:
    #   mongodb:
    #     image: mongo:${{ matrix.mongodb }}
    #     ports:
    #       - 27017:27017

    #   redis:
    #     image: redis:${{ matrix.redis }}
    #     ports:
    #       - 6379:6379

    # steps:
    #   - uses: actions/checkout@v2
    #   - name: Set up Ruby
    #     uses: ruby/setup-ruby@v1
    #     with:
    #       ruby-version: ${{ matrix.ruby }}
    #   - name: Install dependencies
    #     run: bundle install
    #   - name: Setup db, run tests
    #     env:
    #       STAGE: test
    #       MONGO_HOST: localhost
    #       REDIS_HOST: localhost
    #     run: |
    #       bundle exec rspec -f progress

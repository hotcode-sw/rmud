# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# Orbs are reusable packages of CircleCI configuration that you may share across projects, enabling you to create encapsulated, parameterized commands, jobs, and executors that can be used across multiple projects.
# See: https://circleci.com/docs/2.0/orb-intro/
orbs:
  ruby: circleci/ruby@1.4.0

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  build:
    docker:
      - image: cimg/ruby:<< matrix.ruby >>
    executor: ruby/default
    steps:
      - checkout
      - run:
          name: Which bundler?
          command: bundle -v
      - ruby/install-deps

  test:
    parallelism: 2
    docker:
      - image: cimg/ruby:<< matrix.ruby >>
        environment:
          - STAGE: test
          - MONGO_HOST: localhost
          - REDIS_HOST: localhost
      - image: mongo:<< matrix.mongodb >>
      - image: redis:<< matrix.redis >>

    steps:
      - checkout
      - ruby/install-deps
      - run:
          command: "dockerize -wait tcp://localhost:27017 -timeout 1m"
          name: Wait for DB
      - run:
          command: "dockerize -wait tcp://localhost:6379 -timeout 1m"
          name: Wait for Redis
      - run:
          command: |
            shopt -s globstar
            mkdir -p /tmp/test-results/rspec
            TESTFILES=$(circleci tests glob spec/**/*_spec.rb | circleci tests split --split-by=timings)
            bundle exec rspec $TESTFILES --profile 10 --format RspecJunitFormatter --out /tmp/test-results/rspec/results.xml --format progress
          name: Run rspec

      - store_artifacts:
          path: /tmp/test-results/rspec/results.xml

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  sample: # This is the name of the workflow, feel free to change it to better match your workflow.
    # Inside the workflow, you define the jobs you want to run.
    jobs:
      - build:
          matrix:
            parameters:
              ruby: ["3.0"]
      - test:
          matrix:
            parameters:
              ruby: ["3.0"]
              mongodb: ["4.0", "4.2", "4.4"]
              redis: ["5.0", "6.0", "6.2"]
          requires:
            - build

    # strategy:
    #   fail-fast: false
    #   matrix:
    #     ruby: ["3.0"]
    #     mongodb: ["4.0", "4.2", "4.4"]
    #     redis: ["5.0", "6.0", "6.2"]

    # name: Ruby ${{ matrix.ruby }}, MongoDB ${{ matrix.mongodb }}, Redis ${{ matrix.redis }}
    # services:
    #   mongodb:
    #     image: mongo:${{ matrix.mongodb }}
    #     ports:
    #       - 27017:27017

    #   redis:
    #     image: redis:${{ matrix.redis }}
    #     ports:
    #       - 6379:6379

    # steps:
    #   - uses: actions/checkout@v2
    #   - name: Set up Ruby
    #     uses: ruby/setup-ruby@v1
    #     with:
    #       ruby-version: ${{ matrix.ruby }}
    #   - name: Install dependencies
    #     run: bundle install
    #   - name: Setup db, run tests
    #     env:
    #       STAGE: test
    #       MONGO_HOST: localhost
    #       REDIS_HOST: localhost
    #     run: |
    #       bundle exec rspec -f progress
